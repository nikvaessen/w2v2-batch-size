# Instructions for setting up the LibriSpeech dataset

## Setting up the environment

The following environment variables should be set before continuing:

```bash
# example values
LIBRISPEECH_ROOT_DIR=${PWD}/data/librispeech/
LIBRISPEECH_DOWNLOAD_DIR=${LIBRISPEECH_ROOT_DIR}/raw
LIBRISPEECH_EXTRACT_DIR=${LIBRISPEECH_ROOT_DIR}/extract
LIBRISPEECH_SHARD_DIR=${LIBRISPEECH_ROOT_DIR}/shards
LIBRISPEECH_META_DIR=${LIBRISPEECH_ROOT_DIR}/meta
```

## Downloading

Having set `LIBRISPEECH_DOWNLOAD_DIR`, call:

```bash
./librispeech/download_librispeech.sh
```

## Extracting

After having downloaded the dataset, and having set `LIBRISPEECH_EXTRACT_DIR` and `LIBRISPEECH_META_DIR`, call:

```bash
./librispeech/untar_librispeech_archives.sh
```

## Convert to WAV

Having extracted the dataset, you can convert it to wav format by calling:

```bash
NUM_CPU=$(nproc) # or fewer if you want to use the PC for other stuff...
convert_to_wav.py --dir "$LIBRISPEECH_EXTRACT_DIR" --ext .flac --workers="$NUM_CPU"
```

## Write shards

In order to write shards of the data, we must first generate multiple csv files which
describe each split. These csv files are put into a separate folder for each split. 

### default split

In the default split, we have 3 train splits ('clean-100', 'clean-360' and 'other-500), 
as well as 2 dev splits (clean and other) and 2 test splits (clean and other)

Make sure `LIBRISPEECH_SHARD_DIR` is set.

First, call to generate a CSV file for each split :

```bash
./librispeech/default_setup_shards.sh
```

Then, in order to create shards for each split, call:

```bash
./librispeech/default_write_shards.sh
```

#### Generation of additional files

For a speech recognition system, it is useful to know all possible characters in the
transcriptions, and to map these characters to a particular index.
This can be generated by the following command:

```bash
poetry run generate_character_vocabulary \
  "$LIBRISPEECH_SHARD_DIR"/train-clean-100 \
  "$LIBRISPEECH_SHARD_DIR"/train-clean-360 \
  "$LIBRISPEECH_SHARD_DIR"/train-other-500 \
  "$LIBRISPEECH_SHARD_DIR"/val-clean-100 \
  "$LIBRISPEECH_SHARD_DIR"/val-clean-360 \
  "$LIBRISPEECH_SHARD_DIR"/val-other-500 \
  "$LIBRISPEECH_SHARD_DIR"/dev-clean \
  "$LIBRISPEECH_SHARD_DIR"/dev-other \
  "$LIBRISPEECH_SHARD_DIR"/test-clean \
  "$LIBRISPEECH_SHARD_DIR"/test-other \
  --out "$LIBRISPEECH_META_DIR"/character_vocabulary.json
```
